using System;
using System.Collections.Generic;

namespace TestOOP
{
    class Program
    {
        static void Main(string[] args)
        {
            Battle battle = new Battle();

            Console.CursorVisible = false;
            battle.СreateFight();
            Console.ReadKey();
        }
    }

    class Battle
    {
        public void СreateFight()
        {
            CountrySouth fightersSouth = new CountrySouth();
            CountryNorth fightersNorth = new CountryNorth();

            DrawFighters(fightersSouth, fightersNorth);

            while (fightersSouth.GetAmountFighters() > 0 && fightersNorth.GetAmountFighters() > 0)
            {
                Console.ReadKey();
                Console.Clear();
                MakeMoveTeams(fightersSouth, fightersNorth);
                DrawFighters(fightersSouth, fightersNorth);
            }

            if (fightersSouth.GetAmountFighters() > 0)
                Console.Write(" Победил Юг.\n\n");
            else
                Console.Write(" Победил Север.\n\n");
        }

        private void MakeMoveTeams(CountrySouth fightersSouth, CountryNorth fightersNorth)
        {
            MakeMoveTeam(fightersSouth, fightersNorth);
            CheckHealthFighters(fightersSouth, fightersNorth);
        }

        private void MakeMoveTeam(CountrySouth fightersSouth, CountryNorth fightersNorth)
        {
            fightersNorth.MakeMoveFighters(fightersSouth.GetDamage());
            fightersSouth.MakeMoveFighters(fightersNorth.GetDamage());
        }

        private void CheckHealthFighters(CountrySouth fightersSouth, CountryNorth fightersNorth)
        {
            fightersSouth.CheckHealthFighter();
            fightersNorth.CheckHealthFighter();
        }

        private void DrawFighters(CountrySouth fightersSouth, CountryNorth fightersNorth)
        {
            fightersSouth.DrawFighter();
            fightersNorth.DrawFighter();
        }
    }

    class Country
    {
        private readonly int _unitSize = 3;
        private readonly static Random _random = new Random();

        protected virtual void Draw(List<Fighter> fighters)
        {
            for (var i = 0; i < fighters.Count; i++)
            {
                Console.Write($"Боец({i + 1}) ");
                fighters[i].Draw();
            }

            Console.WriteLine("########################################################################################\n");
        }

        protected void CreateFighters(List<Fighter> fighters)
        {
            for (int i = 0; i < _unitSize; i++)
                fighters.Add(new Fighter());
        }

        protected int GetDamage(List<Fighter> fighters)
        {
            int damage = 0;

            for (int i = 0; i < fighters.Count; i++)
            {
                damage += fighters[i].Attack;
            }

            return damage;
        }

        protected void MakeMove(List<Fighter> fighters, int damage)
        {
            int perCent = 100;

            if (_random.Next(0, perCent) > fighters[GetIndexBestFighter(fighters)].Dexterity)
                fighters[GetIndexBestFighter(fighters)].RemoveHealth(damage);
        }

        protected void CheckHealth(List<Fighter> fighters)
        {
            if (fighters[GetIndexBestFighter(fighters)].Health < 1)
                fighters.RemoveAt(GetIndexBestFighter(fighters));
        }

        private int GetIndexBestFighter(List<Fighter> fighters)
        {
            int index = 0;
            int danger = 0;

            for (int i = 0; i < fighters.Count; i++)
            {
                if (fighters[i].Danger > danger)
                {
                    danger = fighters[i].Danger;
                    index = i;
                }
            }
            return index;
        }
    }

    class CountrySouth : Country
    {
        private readonly List<Fighter> _fighters = new List<Fighter>();

        public CountrySouth() { CreateFighters(_fighters); }

        public void DrawFighter()
        {
            Console.WriteLine("Команда Юга:  \n\n");
            base.Draw(_fighters);
        }

        public int GetAmountFighters() { return _fighters.Count; }

        public int GetDamage() { return base.GetDamage(_fighters); }

        public void MakeMoveFighters(int damage) { MakeMove(_fighters, damage); }

        public void CheckHealthFighter() { CheckHealth(_fighters); }
    }

    class CountryNorth : Country
    {
        private readonly List<Fighter> _fighters = new List<Fighter>();

        public CountryNorth() { CreateFighters(_fighters); }

        public void DrawFighter()
        {
            Console.WriteLine("Команда Севера:  \n\n");
            base.Draw(_fighters);
        }

        public int GetAmountFighters() { return _fighters.Count; }

        public int GetDamage() { return base.GetDamage(_fighters); }

        public void MakeMoveFighters(int damage) { MakeMove(_fighters, damage); }

        public void CheckHealthFighter() { CheckHealth(_fighters); }
    }

    class Fighter
    {
        private readonly int _baseDexterity = 10;
        private readonly static Random _random = new Random();
        private readonly WeaponElement _weapons = new WeaponElement();
        private readonly ArmorElement _armors = new ArmorElement();

        public string Weapon { get; private set; }
        public int Attack { get; private set; }
        public string Armor { get; private set; }
        public int Protection { get; private set; }
        public int Health { get; private set; } = 1000;
        public int Dexterity { get; private set; }
        public int Danger { get; private set; }

        public void RemoveHealth(int damage)
        {
            if (damage > Protection)
                Health -= damage - Protection;
        }

        public void Draw()
        {
            Console.WriteLine($" HP({Health}): в руках: {Weapon} - урон: {Attack}. Одет в {Armor} - защита: {Protection}. Ловкость: {Dexterity}\n");
        }

        public Fighter()
        {
            int numberWeapon = _random.Next(0, _weapons.GetListsSize());
            int numberArmor = _random.Next(0, _armors.GetListsSize());

            Weapon = _weapons.GetName(numberWeapon);
            Attack = _weapons.GetListsValue(Weapon);
            Armor = _armors.GetName(numberArmor);
            Protection = _armors.GetListsValue(Armor);
            Health = Health;
            Dexterity = _armors.GetValueDexterity(Armor) + _baseDexterity;
            Danger = (Attack + Protection) * Dexterity;
        }
    }

    class WeaponElement
    {
        private readonly string[] _items = { "Пистолет", "Ружье", "Автомат" };
        private readonly Dictionary<string, int> _attacks = new Dictionary<string, int>();

        public WeaponElement()
        {
            CreateAttacks();
        }

        public int GetListsValue(string name) { return _attacks[name]; }

        public string GetName(int number) { return _items[number]; }

        public int GetListsSize() { return _attacks.Count; }

        private void CreateAttacks()
        {
            for (var i = 0; i < _items.Length; i++)
            {
                _attacks.Add(_items[i], GetAttack(i));
            }
        }

        private int GetAttack(int number)
        {
            int modifier = 35;
            return ++number * modifier;
        }
    }

    class ArmorElement
    {
        private readonly string[] _items = { "Куртка", "Бронижелет", "Доспех" };
        private readonly Dictionary<string, int> _protections = new Dictionary<string, int>();
        private readonly Dictionary<string, int> _dexterityModifiers = new Dictionary<string, int>();

        public ArmorElement()
        {
            CreateDictionaries();
        }

        public int GetListsValue(string name) { return _protections[name]; }

        public string GetName(int number) { return _items[number]; }

        public int GetValueDexterity(string name) { return _dexterityModifiers[name]; }

        public int GetListsSize() { return _protections.Count; }

        public string GetNameArmor(int number) { return _items[number]; }

        private void CreateDictionaries()
        {
            for (int i = 0; i < _items.Length; i++)
            {
                _protections.Add(_items[i], GetProtection(i));
                _dexterityModifiers.Add(_items[i], CreateDexterityModifier(i));
            }
        }

        private int GetProtection(int number)
        {
            int modifier = 10;
            return modifier * ++number;
        }

        private int CreateDexterityModifier(int number)
        {
            int modifier = 10;
            return modifier / ++number + modifier;
        }
    }
}
